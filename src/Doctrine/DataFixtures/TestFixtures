<?php

namespace App\Doctrine\DataFixtures;

use App\Model\Entity\Review;
use App\Model\Entity\Tag;
use App\Model\Entity\User;
use App\Model\Entity\VideoGame;
use App\Rating\CalculateAverageRating;
use App\Rating\CountRatingsPerValue;
use DateTimeImmutable;
use Doctrine\Bundle\FixturesBundle\Fixture;
use Doctrine\Persistence\ObjectManager;
use Faker\Generator;

final class DataFixtures extends Fixture
{
    public function __construct(
        private readonly Generator $faker,
        private readonly CalculateAverageRating $calculateAverageRating,
        private readonly CountRatingsPerValue $countRatingsPerValue,
    )
    {
        $calculateAverageRating = $this->calculateAverageRating;
        $countRatingsPerValue = $this->countRatingsPerValue;
    }

    public function load(ObjectManager $manager) : void
    {
    //USER TEST
        $userTest = new User();
        $userTest->setEmail('usertestd@email.com');
        $userTest->setPlainPassword('password');
        $userTest->setUsername('usertest');
        $manager->persist($userTest);
        $manager->flush();

        $tags = $manager->getRepository(Tag::class)->findAll();
        $users = $manager->getRepository(User::class)->findBy('usertest');

    // VIDEOGAMES
        $videoGameTest0 = new VideoGame();
        $videoGameTest0->setTitle('Jeu test noreview');
        $videoGameTest0->setImageName('video_game_0.png');
        $videoGameTest0->setImageSize(2541524);
        $videoGameTest0->setDescription('Descritpion du Jeu vidéo test noreview');
        $videoGameTest0->setReleaseDate(new DateTimeImmutable());
        $videoGameTest0->setTest('Test Noreview');
        $videoGameTest0->setRating(3);     
        $manager->persist($videoGameTest0);

        $videoGameTest = new VideoGame();
        $videoGameTest->setTitle('Jeu test review');
        $videoGameTest->setImageName('video_game_0.png');
        $videoGameTest->setImageSize(2541524);
        $videoGameTest->setDescription('Descritpion du Jeu vidéo test review');
        $videoGameTest->setReleaseDate(new DateTimeImmutable());
        $videoGameTest->setTest('Test Review');
        $videoGameTest->setRating(4);     
    
    // REVIEWS
        $reviewTest = new Review();
        $reviewTest->setVideoGame($videoGameTest);
        $reviewTest->setUser($userTest);
        $reviewTest->setRating(5);
        $reviewTest->setComment('Commentaire Review Test');
        $manager->persist($reviewTest);
        $videoGameTest->getReviews()->add($reviewTest);

    // TAGS

        $videoGameTest->getTags()->add($tags[1]);    
                    
        $manager->persist($reviewTest);
        $manager->persist($videoGameTest);
        $this->calculateAverageRating->calculateAverage($videoGameTest);
        $this->countRatingsPerValue->countRatingsPerValue($videoGameTest);

        $manager->flush();
    }
}